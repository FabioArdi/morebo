{% extends '_base.html' %}
{% set active_page = "index" %}
{% block title %}Home{% endblock %}
{% block content %}
{% include 'helpers/movie_autocomplete.html' %}
<style>
  .carousel-item {
    transition: transform .5s ease-in-out;
  }

  input.star {
    display: none;
  }

  label.star {
    float: right;
    padding: 3px;
    margin: 0 3px 0 3px;
    font-size: 16px;
    color: rgb(255, 189, 34);
    transition: all .2s;
  }

  input.star:checked~label.star:before {
    content: '\f005';
    color: rgb(255, 189, 34);
    transition: all .25s;
  }

  input.star-1:checked~label.star:before {
    color: rgb(255, 189, 34);
  }

  input.star-5:checked~label.star:before {
    color: rgb(255, 189, 34);
    text-shadow: 0 0 20px rgb(175, 102, 47);
  }

  label.star:hover {
    transform: rotate(-10deg) scale(1.2);
  }

  label.star:before {
    content: '\f006';
    font-family: FontAwesome;
  }
</style>
<h1 class="text-center mb-5">Welcome to MoReBo</h1>
<p class="lead text-center mb-5">MoReBo is your personal movie recommendation bot. Simply tell us what you like, and
  we'll recommend movies you'll love.</p>
<hr>
<p class="text-center form-text">Choose from one of the two options below to get started!</p>

<div class="btn-group" role="group">
  <input type="radio" class="btn-check" name="btnradio" id="btnradio1" checked onclick="slide(this.id)">
  <label class="btn btn-outline-primary" for="btnradio1">Select your favourite movie</label>
  <input type="radio" class="btn-check" name="btnradio" id="btnradio2" onclick="slide(this.id)">
  <label class="btn btn-outline-primary" for="btnradio2">Rate multiple movies</label>
</div>
<div id="formCarousel" class="carousel slide mb-5" data-bs-interval="false">
  <div class="carousel-inner">
    <!-- Option 1: Enter favourite movie -->
    <div class="carousel-item active mt-5">
      <div class="input-group has-validation">
        <input type="text" class="form-control autocomplete" id="movieInput"
          placeholder="Enter your favourite movie title">
        <div class="invalid-feedback">
          Please select a movie from the list.
        </div>
      </div>
      <button class="btn btn-primary mt-3" id="submitSingleBtn" onclick="getSingleRecommendations()">Get
        Recommendations</button>
    </div>
    <!-- Option 2: Rate multiple movies -->
    <div class="carousel-item">
      <div class="input-group mt-5" id="multipleMovies">
        {% set movie_names = ['Inception', 'The Dark Knight', 'The Matrix', 'Interstellar', 'The Prestige'] %}
        {% for i in range(5) %}
        <div class="input-group mb-3 has-validation">
          <input type="text" class="form-control autocomplete" placeholder="{{movie_names[i]}}">
          <form>
            <input class="star star-5" id="star-{{i}}-5" type="radio" name="star" value="5" />
            <label class="star star-5" for="star-{{i}}-5"></label>
            <input class="star star-4" id="star-{{i}}-4" type="radio" name="star" value="4" />
            <label class="star star-4" for="star-{{i}}-4"></label>
            <input class="star star-3" id="star-{{i}}-3" type="radio" name="star" value="3" />
            <label class="star star-3" for="star-{{i}}-3"></label>
            <input class="star star-2" id="star-{{i}}-2" type="radio" name="star" value="2" />
            <label class="star star-2" for="star-{{i}}-2"></label>
            <input class="star star-1" id="star-{{i}}-1" type="radio" name="star" value="1" />
            <label class="star star-1" for="star-{{i}}-1"></label>
          </form>
          <div class="invalid-feedback">
            Please select a movie from the list.
          </div>
        </div>
        {% endfor %}
      </div>
      <button class="btn btn-primary mt-3" id="submitMultipleBtn" onclick="getMultipleRecommendations()">Get
        Recommendations</button>
    </div>
  </div>
</div>
<div id="movieRecommendations" class="mt-5 mb-3 d-none" id="movieRecommendationsResult">
  <h2 class="text-center mb-5">Your recommendations</h2>
  <div class="row row-cols-1 row-cols-md-3 g-4" id="movieRecommendationsRow">
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>
<script>
  var formCarousel = document.querySelector('#formCarousel')
  var carousel = new bootstrap.Carousel(formCarousel)
  var slideIndex = 0

  // fetch movie titles from API at /api/movies/title/ using AJAX GET request
  var validMovieTitles
  fetch('/api/movies/title/')
    .then(response => response.json())
    .then(data => {
      validMovieTitles = data
    })

  // ##############################
  // # Functions
  // ##############################
  function slide(id) {
    if (id == 'btnradio1') {
      carousel.to(0)
      slideIndex = 0
    } else {
      carousel.to(1)
      slideIndex = 1
    }
  }

  function getSingleRecommendations() {
    var movieInput = document.querySelector('#movieInput')
    var selectedMovie = movieInput.value

    if (selectedMovie != '') {
      if (JSON.stringify(validMovieTitles).includes(selectedMovie)) {
        movieInput.classList.remove('is-invalid')
        movieInput.classList.add('is-valid')
        get_movies('single')
      } else {
        movieInput.classList.add('is-invalid')
      }
    } else {
      movieInput.classList.add('is-invalid')
    }
  }

  function getMultipleRecommendations() {
    var movieInputs = document.querySelectorAll('#multipleMovies .form-control')
    // save movie titles in array
    var selectedMovies = []
    movieInputs.forEach(movieInput => {
      if (movieInput.value != '') {
        if (JSON.stringify(validMovieTitles).includes(movieInput.value)) {
          selectedMovies.push(movieInput.value)
          movieInput.classList.remove('is-invalid')
          movieInput.classList.add('is-valid')
        } else {
          movieInput.classList.add('is-invalid')
        }
      } else {
        movieInput.classList.add('is-invalid')
      }
    })
    if (selectedMovies.length == 5) {
      get_movies('multiple')
    }
  }

  function get_movies(type) {
    var btn
    if (type == "single") {
      btn = document.querySelector("#submitSingleBtn")
      var movieInput = document.querySelector("#movieInput").value
      // make json object
      var selectedMovies = {
        userId: 0,
        ratings: [
          { movieTitle: movieInput, rating: 5, movieId: 0 }
        ]
      }
    } else if (type == "multiple") {
      btn = document.querySelector("#submitMultipleBtn")
      var movieInputs = document.querySelectorAll("#multipleMovies .form-control")
      var ratings = document.querySelectorAll("#multipleMovies .star:checked")

      // save movie titles in array
      var selectedMovies = {
        userId: 0,
        ratings: []
      }
      movieInputs.forEach(function (movieInput, index) {
        selectedMovies.ratings.push({
          movieTitle: movieInput.value,
          rating: Number(ratings[index].value),
          movieId: 0
        })
      })
    } else {
      console.log("Error: Invalid type")
    }

    selectedMovies = JSON.stringify(selectedMovies) // convert to JSON string

    // Hide button text and show spinner
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>'

    $.ajax({
      url: "api/model/pearson/",
      dataType: "json",
      cache: false,
      contentType: false,
      processData: false,
      data: selectedMovies,
      type: "POST",
      success: function (response) {
        var movieRecommendationsRow = document.querySelector("#movieRecommendationsRow")
        movieRecommendationsRow.innerHTML = ""
        // Array to store all the promises
        var movieMetaData = []

        response.forEach(function (movie) {
          // Fetch movie meta data and store the promise
          var moviePromise = get_movie_meta_data(movie.Title)
          movieMetaData.push(moviePromise)

          moviePromise.then(function (movie_data) {
            movieRecommendationsRow.innerHTML += `
            <div class="col">
              <div class="card h-100">
                <img src="${movie_data.Poster}" class="card-img-top" alt="...">
                <div class="card-body">
                  <h5 class="card-title">${movie_data.Title}</h5>
                  <p class="card-text">${movie_data.Genre}</p>
                </div>
              </div>
            </div>
            `
          })
            .catch(function (error) {
              console.log("Error retrieving movie data:", error)
            })
        })
      },
      error: function (response) {
        console.log(response)
      },
      complete: function (response) {
        $("#movieRecommendations").removeClass("d-none")
        // Show button text and hide spinner
        btn.innerHTML = "Get Recommendations"

      }
    })
  }

  function get_movie_meta_data(movieTitle) {
    return fetch("api/movies/" + movieTitle)
      .then(function (response) {
        if (!response.ok) {
          throw new Error("Request failed with status: " + response.status)
        }
        return response.json()
      })
      .then(function (data) {
        return data[0]
      })
      .catch(function (error) {
        console.log("Error: " + error)
      })
  }

</script>
{% endblock %}